var MainRouter=Backbone.Router.extend({routes:{"":"gotoIndexPage",map:"gotoMapPage"},gotoIndexPage:function(){$(".js-wrapper").addClass("_index"),$(".js-index__nav").fadeIn()},gotoMapPage:function(){$(".js-wrapper").removeClass("_index"),$(".js-index__nav").fadeOut()}}),mainRouter=new MainRouter;Backbone.history.start();var PoiModel=Backbone.Model.extend({initialize:function(){this.listenTo(this,"change",this.saveModel)},saveModel:function(e){e.save()}}),PoiMapView=Backbone.View.extend({el:".h-map",template:_.template($("#poi-map__template").html()),initialize:function(){this.createMarker(),this.createRoute(),this.listenTo(this.model,"change",this.render,this),this.listenTo(this.model,"destroy",this.destroyView,this),this.listenTo(this.model,"openEdit",this.startAnimation,this),this.listenTo(this.model,"closeEdit",this.finishAnimation,this),this.listenTo(this.model,"mouseover",this.mouseover,this),this.listenTo(this.model,"mouseout",this.mouseout,this),this.listenTo(this.model,"updateRoute",this.updateRoute,this),this.listenTo(this.model,"destroyRoute",this.destroyRoute,this)},bindEvents:function(){$(".b-poi__edit").on("click",$.proxy(this.editPoi,this))},createMarker:function(){this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("positionLat"),this.model.get("positionLng")),map:map,animation:google.maps.Animation.DROP,icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",draggable:!0});var e=$.proxy(function(){this.infoWindow.open(map,this.marker),this.bindEvents()},this),t=$.proxy(function(e){this.model.set({positionLat:e.latLng.lat(),positionLng:e.latLng.lng()})},this),i=$.proxy(function(){this.model.trigger("closeEdit")},this);this.infoWindow=new google.maps.InfoWindow({content:this.template(this.model)}),google.maps.event.addListener(this.marker,"click",e),google.maps.event.addListener(this.marker,"dragend",t),google.maps.event.addListener(this.infoWindow,"closeclick",i)},createRoute:function(){this.route={},this.polyline={},this.route.rendererOptions={draggable:!0,preserveViewport:!0},this.route.directionsDisplay=new google.maps.DirectionsRenderer(this.route.rendererOptions),this.route.directionsService=new google.maps.DirectionsService,this.route.directionsDisplay.setOptions({suppressMarkers:!0}),this.updateRoute(!1)},updateRoute:function(o){o?(this.route.directionsDisplay.setMap(null),$.isEmptyObject(this.polyline)||this.polyline.setMap(null)):o=[this.model.get("positionLat"),this.model.get("positionLng")],this.route.request={origin:new google.maps.LatLng(this.model.get("positionLat"),this.model.get("positionLng")),destination:new google.maps.LatLng(o[0],o[1]),travelMode:google.maps.TravelMode.DRIVING};var n=$.proxy(function(){this.route.directionsService.route(this.route.request,$.proxy(function(e,t){if(t==google.maps.DirectionsStatus.OK)this.route.directionsDisplay.setDirections(e),this.route.directionsDisplay.setMap(map);else if(t==google.maps.DirectionsStatus.ZERO_RESULTS){var i=[new google.maps.LatLng(this.model.get("positionLat"),this.model.get("positionLng")),new google.maps.LatLng(o[0],o[1])];this.polyline=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:4}),this.polyline.setMap(map)}else"OVER_QUERY_LIMIT"==t&&_.delay(n,500)},this))},this);_.once(n)()},editPoi:function(){this.model.trigger("openEdit")},mouseover:function(){this.marker.set("icon","http://maps.google.com/mapfiles/ms/icons/green-dot.png"),map.panTo(new google.maps.LatLng(this.model.get("positionLat"),this.model.get("positionLng")))},mouseout:function(){this.marker.set("icon","http://maps.google.com/mapfiles/ms/icons/blue-dot.png")},startAnimation:function(){this.marker.setAnimation(google.maps.Animation.BOUNCE),map.panTo(new google.maps.LatLng(this.model.get("positionLat"),this.model.get("positionLng")))},finishAnimation:function(){this.marker.setAnimation(null)},render:function(){this.infoWindow.setContent(this.template(this.model))},destroyView:function(){this.marker.setMap(null),$.isEmptyObject(this.polyline)||this.polyline.setMap(null),this.route.directionsDisplay.setMap(null)},destroyRoute:function(){$.isEmptyObject(this.polyline)||this.polyline.setMap(null),this.route.directionsDisplay.setMap(null)}}),PoiListView=Backbone.View.extend({tagName:"li",className:"b-poi__list__frame",template:_.template($("#poi-list__template").html()),events:{"click .b-edit":"openEditor",mouseover:"isHovered",mouseout:"isNoHovered","click .b-delete":"destroy"},initialize:function(){this.listenTo(this.model,"change",this.render,this),this.listenTo(this.model,"destroy",this.destroyView,this),this.listenTo(this.model,"openEdit",this.startAnimation,this),this.listenTo(this.model,"closeEdit",this.finishAnimation,this)},startAnimation:function(){this.$el.addClass("animate")},finishAnimation:function(){this.$el.removeClass("animate")},isHovered:function(){this.model.trigger("mouseover")},isNoHovered:function(){this.model.trigger("mouseout")},destroy:function(){swal({title:"Are you sure,",text:"that you want to delete this highlight?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete!",closeOnConfirm:!1},$.proxy(function(){this.model.destroy(),swal("Highlight was deleted!","You can continue redacting","success")},this))},destroyView:function(){this.$el.remove()},render:function(){this.$el.html(this.template(this.model))},openEditor:function(){this.model.trigger("openEdit")}}),PoiImagesView=Backbone.View.extend({tagName:"li",className:"b-poi__images__frame",template:_.template($("#poi-images__template").html()),events:{click:"setOpenEditActive",dblclick:"destroy",mouseenter:"isHovered",mouseleave:"isNoHovered"},initialize:function(){this.listenTo(this.model,"change",this.render,this),this.listenTo(this.model,"destroy",this.destroyView,this),this.listenTo(this.model,"openEdit",this.startAnimation,this),this.listenTo(this.model,"closeEdit",this.finishAnimation,this)},isHovered:function(){this.model.trigger("mouseover")},isNoHovered:function(){this.model.trigger("mouseout")},startAnimation:function(){this.$el.addClass("animate")},finishAnimation:function(){this.$el.removeClass("animate")},setOpenEditActive:function(){this.model.trigger("openEdit")},destroyView:function(){this.$el.remove()},render:function(){this.$el.html(this.template(this.model))},destroy:function(){swal({title:"Are you sure,",text:"that you want to delete this highlight?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete!",closeOnConfirm:!1},$.proxy(function(){this.model.destroy(),swal("Highlight was deleted!","You can continue redacting","success")},this))}}),PoiEditorView=Backbone.View.extend({tagName:"div",className:"b-poi-editor",template:_.template($("#poi-editor__template").html()),initialize:function(){this.listenTo(this.model,"openEdit",this.render,this),this.listenTo(this.model,"closeEdit",this.closeEditor,this),this.listenTo(this.model,"destroy",this.closeEditorWithModelEvent,this),this.listenTo(this.model,"change:imageSrc",this.render,this)},bindEvents:function(){$(".b-saveEdit").on("click",$.proxy(this.saveModel,this)),$(".b-deletePoi").on("click",$.proxy(this.destroy,this)),$(".b-closeEdit").on("click",$.proxy(this.closeEditorWithModelEvent,this)),$("#input-file").on("change",$.proxy(this.addImage,this))},addImage:function(){var t=this;if(document.getElementById("input-file").files[0]){var e=new FileReader;e.readAsDataURL(document.getElementById("input-file").files[0]),e.onload=function(e){t.model.set({imageSrc:e.target.result})}}},destroy:function(){swal({title:"Are you sure,",text:"that you want to delete this highlight?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete!",closeOnConfirm:!1},$.proxy(function(){this.model.destroy(),swal("Highlight was deleted!","You can continue redacting","success")},this))},render:function(){this.$el.remove(),$(".b-poi__list__holder").append(this.$el.html(this.template(this.model))),this.bindEvents()},closeEditorWithModelEvent:function(){this.model.trigger("closeEdit"),this.$el.remove()},closeEditor:function(){this.$el.remove()},saveModel:function(){this.model.save({title:this.$el.find(".edit__title").val(),description:this.$el.find(".edit__description").val()}),this.closeEditorWithModelEvent()}}),poiAppCollection=Backbone.Collection.extend({model:PoiModel,localStorage:new Backbone.LocalStorage("PoiEditor")}),PoiAppCollection=new poiAppCollection,MainView=Backbone.View.extend({el:".js-wrapper",events:{"click .js-toggle__editor":"listenMapClick","click .js-cancel__add":"stopListenMapClick","click .js-poi__list__create__link":"createLink","click .js-add__share":"addShare","click .js-poi__list__delete__all":"deleteAllModels"},initialize:function(){this.modelNum=0,this.createMap(),this.listenTo(PoiAppCollection,"add",this.addOne),this.listenTo(PoiAppCollection,"change",this.updateRoute),this.listenTo(PoiAppCollection,"destroy",this.destroyRoute),PoiAppCollection.fetch(),this.countId()},createMap:function(){var e={zoom:2,center:new google.maps.LatLng(0,0)};map=new google.maps.Map(document.getElementById("map"),e)},listenMapClick:function(){var e=$.proxy(function(e){this.createNewModel(e.latLng),this.stopListenMapClick()},this);this.listener=google.maps.event.addListener(map,"click",e),map.set("draggableCursor","crosshair")},stopListenMapClick:function(){google.maps.event.removeListener(this.listener),map.set("draggableCursor",null)},createLink:function(){PoiAppCollection.length?swal({title:"Warning:",text:"Photos can't be copied!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, copy the base!",closeOnConfirm:!1},$.proxy(function(){var e={};e.Main=localStorage.getItem("PoiEditor");for(var t=e.Main.split(","),i=0;i<t.length;i++){var o=JSON.parse(localStorage.getItem("PoiEditor-"+t[i]));o.imageSrc="",e[i]=JSON.stringify(o)}this.$el.find(".js-poi__list__share").text(JSON.stringify(e)),swal("Base is ready to copy!","You can share by it now!","success")},this)):swal("Error","Your base is empty!","error")},addShare:function(){swal({title:"Are you sure",text:"You will lost your current route!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, upload the base!",closeOnConfirm:!1},$.proxy(function(){try{var e=JSON.parse(this.$el.find(".js-poi__list__input-share").val());localStorage.clear(),localStorage.setItem("PoiEditor",e.Main);for(var t=e.Main.split(","),i=0;i<t.length;i++)localStorage.setItem("PoiEditor-"+t[i],e[i]);location.reload()}catch(e){swal("Error!","Please check your input data","error")}},this))},countId:function(){PoiAppCollection.length?this.counter=_.max(PoiAppCollection.pluck("id"))+1||0:this.counter=0},createNewModel:function(e){PoiAppCollection.create({positionLat:e.lat(),positionLng:e.lng(),title:"New POI "+this.counter,id:this.counter}),this.counter++},updateRoute:function(t){var i=[],o=[];t.number&&PoiAppCollection.each(function(e){e.number===t.number-1&&e.trigger("updateRoute",[t.get("positionLat"),t.get("positionLng")])}),PoiAppCollection.each(function(e){i.push(e.number)}),PoiAppCollection.each(function(e){e.number===t.number+1&&(o=[e.get("positionLat"),e.get("positionLng")])}),PoiAppCollection.each(function(e){e.number===t.number&&e.trigger("updateRoute",o)})},destroyRoute:function(t){var i={};t.number===PoiAppCollection.length?(PoiAppCollection.each(function(e){e.number===t.number-1&&(i=e.id)}),PoiAppCollection.length&&PoiAppCollection.get(i).trigger("destroyRoute")):0===t.number?PoiAppCollection.each(function(e){e.number=e.number-1}):(PoiAppCollection.each(function(e){e.number>t.number?e.number=e.number-1:e.number===t.number-1&&(i=e.id)}),this.updateRoute(PoiAppCollection.get(i))),this.modelNum=this.modelNum-1},addOne:function(e){e.number=this.modelNum++;new PoiMapView({model:e}),new PoiEditorView({model:e});var t=new PoiListView({model:e}),i=new PoiImagesView({model:e});$(".b-poi__list").append(t.$el.html(t.template(e))),$(".b-poi__images").append(i.$el.html(i.template(e))),this.updateRoute(e)},deleteAllModels:function(){PoiAppCollection.length?swal({title:"Are you sure,",text:"that you want to delete all highlights?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete all!",closeOnConfirm:!1},$.proxy(function(){for(;model=PoiAppCollection.first();)model.destroy();swal("Base is empty!","You can create a new route","success")},this)):swal("Nothing to delete","You have no any highlights!","error"),localStorage.clear()}}),mainView=new MainView;